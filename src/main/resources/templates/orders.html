<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление заказами</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>

<header>
    <div class="container">
        <h1 class="logo">
            <i class="fas fa-shopping-cart"></i> Управление заказами
        </h1>

        <nav class="navbar">
            <a href="/" class="active"><i class="fas fa-home"></i> Главная</a>
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> Выйти</a>
        </nav>
    </div>
</header>

<main>
    <div class="management">

        <div class="management-title">
            <h2>Управление заказами</h2>
            <p>Здесь вы можете посмотреть все заказы и оформить новый</p>
        </div>

        <div class="management-actions">

            <div class="button-container">
                <button class="management-item" onclick="loadOrders()">
                    <i class="fas fa-list"></i> Все заказы
                    <span class="management-tooltip">Просмотреть все заказы</span>
                </button>
            </div>

            <div class="button-container">
                <button class="management-item" onclick="showAddOrders()">
                    <i class="fas fa-plus-circle"></i> Оформить заказ
                    <span class="management-tooltip">Создать новый заказ</span>
                </button>
            </div>
        </div>

        <div class="table-container" id="ordersTableContainer" style="display: none; margin-top: 20px;">
            <h3>Список всех заказов</h3>
            <table id="table">
                <thead>
                <tr>
                    <th>
                        <div class="input-with-reset">
                            <input type="text" id="managerSearch" placeholder="Поиск по менеджеру"
                                   oninput="applyFilters()">
                            <button type="button" onclick="resetInput('managerSearch')" class="reset-button">&#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset">
                            <input type="text" id="companySearch" placeholder="Поиск по контрагенту"
                                   oninput="applyFilters()">
                            <button type="button" onclick="resetInput('companySearch')" class="reset-button">&#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset">
                            <input type="text" id="dateFromSearch" placeholder="Дата от" class="date-input">
                            <button type="button" onclick="resetInput('dateFromSearch'); resetInput('dateToSearch')"
                                    class="reset-button">&#10006;
                            </button>
                            <input type="text" id="dateToSearch" placeholder="Дата до" class="date-input">
                            <button type="button" onclick="resetInput('dateFromSearch'); resetInput('dateToSearch')"
                                    class="reset-button">&#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset">
                            <input type="text" id="totalSearch" placeholder="Поиск по сумме заказа"
                                   oninput="applyFilters()">
                            <button type="button" onclick="resetInput('totalSearch')" class="reset-button">&#10006;
                            </button>
                        </div>
                    </th>

                    <th>
                        <div class="sort-container">
                            <label for="ordersSort">Сортировать по:</label>
                            <select id="ordersSort" onchange="applyFilters()">
                                <option value="">Выберите</option>
                                <option value="manager_asc">Менеджер (А-Я)</option>
                                <option value="manager_desc">Менеджер (Я-А)</option>
                                <option value="company_asc">Контрагент (А-Я)</option>
                                <option value="company_desc">Контрагент (Я-А)</option>
                                <option value="date_asc">Дата (по возрастанию)</option>
                                <option value="date_desc">Дата (по убыванию)</option>
                                <option value="total_asc">Сумма (по возрастанию)</option>
                                <option value="total_desc">Сумма (по убыванию)</option>
                            </select>
                        </div>
                    </th>
                </tr>
                <tr>
                    <th>Менеджер</th>
                    <th>Контрагент</th>
                    <th>Дата</th>
                    <th>Сумма</th>
                    <th>Действия</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="pagination" id="ordersPagination">
                <button onclick="prevOrdersPage()">Назад</button>
                <span id="ordersPageInfo">Страница 1</span>
                <button onclick="nextOrdersPage()">Вперед</button>
            </div>

            <div class="page-size-selector">
                <button onclick="setAmountOrdersPerPage(10)">10</button>
                <button onclick="setAmountOrdersPerPage(30)">30</button>
                <button onclick="setAmountOrdersPerPage(90)">90</button>
            </div>
            <div class="hide-table-btn-container">
                <button class="hide-table-btn" onclick="toggleOrdersTableVisibility()">Скрыть таблицу</button>
            </div>
        </div>

        <div class="table-container" id="orderDetailsModal" style="display: none">
            <h3>Детали заказа</h3>
            <table id="orderGoodsTable">
                <thead>
                <tr>
                    <th>Товар</th>
                    <th>Количество</th>
                    <th>Сумма</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="form-buttons">
                <button type="button" onclick="toggleAddGoodForm()">Добавить товар</button>
                <button type="button" class="btn-success" onclick="saveAllChanges()">Сохранить изменения</button>
                <button type="button" class="btn-danger" onclick="closeOrderDetailsModal()">Закрыть</button>
            </div>
        </div>

        <div class="table-container" id="addGoodFormContainer" style="display: none;">
            <h3>Добавить товар в заказ</h3>
            <table id="goodsTable">
                <thead>
                <tr>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="searchGood" placeholder="Поиск по товару"
                                   oninput="applyGoodsSearch()">
                            <button type="button" onclick="resetInputForGoods('searchGood')" class="reset-button">
                                &#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="editCategorySearch" placeholder="Поиск по категории"
                                   oninput="filterCategories()">
                            <button type="button" onclick="resetInputForGoods('editCategorySearch')"
                                    class="reset-button">&#10006;
                            </button>
                            <select id="editCategory" class="category-select" onchange="applyGoodsSearch()" required
                                    size="3">
                                <option value="" disabled selected>Выберите категорию</option>
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="salePriceSearch" placeholder="Поиск по цене"
                                   oninput="applyGoodsSearch()">
                            <button type="button" onclick="resetInputForGoods('salePriceSearch')" class="reset-button">
                                &#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="balanceSearch" placeholder="Поиск по остатку"
                                   oninput="applyGoodsSearch()">
                            <button type="button" onclick="resetInputForGoods('balanceSearch')" class="reset-button">
                                &#10006;
                            </button>
                        </div>
                    </th>
                    <th></th>
                    <th></th>
                </tr>

                <tr>
                    <th>Товар</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Остаток</th>
                    <th>Количество</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="pagination" id="AddGoodPagination">
                <button onclick="prevGoodsPage()">Назад</button>
                <span id="goodPageInfo">Страница 1</span>
                <button onclick="nextGoodsPage()">Вперед</button>
            </div>

            <div class="page-size-selector">
                <button onclick="setAmountGoodsPerPage(5)">5</button>
                <button onclick="setAmountGoodsPerPage(15)">15</button>
                <button onclick="setAmountGoodsPerPage(30)">30</button>
            </div>

            <div class="hide-table-btn-container">
                <button class="hide-table-btn" onclick="toggleAddGoodFormVisibility()">Скрыть таблицу</button>
            </div>
        </div>

        <div class="add-form" id="addedGoodsForm" style="display: none; margin-top: 20px;">
            <h4>Добавленные товары</h4>
            <table id="addedGoodsTable">
                <thead>
                <tr>
                    <th>Товар</th>
                    <th>Количество</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="form-buttons">
                <button class="btn-success" type="button" onclick="confirmAddGoods()">Подтвердить изменения</button>
                <button class="btn-danger" type="button" onclick="closeAddGoodForm()">Закрыть форму добавления</button>
            </div>
        </div>

        <div class="table-container" id="newOrderDetailsModal" style="display: none;">
            <h3>Детали нового заказа</h3>
            <form id="newOrderForm">
                <div class="form-group">
                    <label for="companySelect">Выберите компанию</label>
                    <select id="companySelect" name="company" required>
                        <option value="" disabled selected>Выберите компанию</option>
                    </select>
                </div>
                <h4>Добавленные товары</h4>
                <table id="newOrderDetailsTable">
                    <thead>
                    <tr>
                        <th>Товар</th>
                        <th>Количество</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <div class="form-buttons">
                    <button type="button" onclick="toggleNewOrderAddGoodForm()">Добавить товар</button>
                    <button type="button" class="btn-success" onclick="submitOrder()">Подтвердить заказ</button>
                    <button type="button" class="btn-danger" onclick="closeNewOrderDetailsModal()">Закрыть</button>
                </div>
            </form>
        </div>

        <div class="table-container" id="newAddGoodFormContainer" style="display: none;">
            <h3>Добавить товар в заказ</h3>
            <table id="newGoodsTable">
                <thead>
                <tr>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="newSearchGood" placeholder="Поиск по товару"
                                   oninput="applyNewOrdersGoodsSearch()">
                            <button type="button" onclick="resetInputForNewOrdersGoods('newSearchGood')"
                                    class="reset-button">
                                &#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="addCategorySearch" placeholder="Поиск по категории"
                                   oninput="filterNewOrderCategories()">
                            <button type="button" onclick="resetInputForNewOrdersGoods('addCategorySearch')"
                                    class="reset-button">&#10006;
                            </button>
                            <select id="addCategory" class="category-select" onchange="applyNewOrdersGoodsSearch()"
                                    required
                                    size="3">
                                <option value="" disabled selected>Выберите категорию</option>
                            </select>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="newSalePriceSearch" placeholder="Поиск по цене"
                                   oninput="applyNewOrdersGoodsSearch()">
                            <button type="button" onclick="resetInputForNewOrdersGoods('newSalePriceSearch')"
                                    class="reset-button">&#10006;
                            </button>
                        </div>
                    </th>
                    <th>
                        <div class="input-with-reset search-item">
                            <input type="text" id="newBalanceSearch" placeholder="Поиск по остатку"
                                   oninput="applyNewOrdersGoodsSearch()">
                            <button type="button" onclick="resetInputForNewOrdersGoods('newBalanceSearch')"
                                    class="reset-button">
                                &#10006;
                            </button>
                        </div>
                    </th>
                    <th></th>
                    <th></th>
                </tr>

                <tr>
                    <th>Товар</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Остаток</th>
                    <th>Количество</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="pagination" id="newAddGoodPagination">
                <button onclick="prevNewOrderGoodsPage()">Назад</button>
                <span id="newGoodPageInfo">Страница 1</span>
                <button onclick="nextNewOrderGoodsPage()">Вперед</button>
            </div>

            <div class="page-size-selector">
                <button onclick="setAmountNewOrderGoodsPerPage(5)">5</button>
                <button onclick="setAmountNewOrderGoodsPerPage(15)">15</button>
                <button onclick="setAmountNewOrderGoodsPerPage(30)">30</button>
            </div>

            <div class="hide-table-btn-container">
                <button class="hide-table-btn" onclick="toggleNewAddGoodFormVisibility()">Скрыть таблицу</button>
            </div>
        </div>

        <div class="add-form" id="newAddedGoodsForm" style="display: none; margin-top: 20px;">
            <h4>Добавленные товары</h4>
            <table id="newAddedGoodsTable">
                <thead>
                <tr>
                    <th>Товар</th>
                    <th>Количество</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="form-buttons">
                <button class="btn-success" type="button" onclick="confirmNewAddGoods()">Подтвердить изменения</button>
                <button class="btn-danger" type="button" onclick="closeNewAddGoodForm()">Закрыть форму добавления
                </button>
            </div>
        </div>

    </div>
    <button onclick="window.location.href='/'" class="back-to-main-btn">Вернуться на главную</button>
</main>


<script>

    function closeNewAddGoodForm() {
        let form = document.getElementById("newAddedGoodsForm");
        form.style.display = "none";
    }

    function showAddOrders() {
        const tableContainer = document.getElementById('newOrderDetailsModal');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
        loadCompanies();
    }

    function closeNewOrderDetailsModal() {
        const tableContainer = document.getElementById('newOrderDetailsModal');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    function loadCompanies() {
        fetch('/companies/list/active')
            .then(response => response.json())
            .then(companies => {
                const companySelect = document.getElementById("companySelect");
                companies.forEach(company => {
                    const option = document.createElement("option");
                    option.value = company.id;
                    option.textContent = company.name;
                    companySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Ошибка при загрузке компаний:', error);
                alert("Не удалось загрузить список компаний.");
            });
    }

    function applyNewOrdersGoodsSearch() {
        const goodNameSearch = document.getElementById('newSearchGood').value;
        const selectedCategory = document.getElementById('addCategory').value;
        const salePriceSearch = document.getElementById('newSalePriceSearch').value;
        const balanceSearch = document.getElementById('newBalanceSearch').value;
        loadNewOrderGoodsList(goodNameSearch, selectedCategory, salePriceSearch, balanceSearch);
    }

    let currentNewOrdersGoodsPage = 0;
    let amountNewOrderGoodsPerPage = 5;
    let totalNewOrderGoodsPages = 1;

    function loadNewOrderGoodsList(name = '', categoryId = '', price = '', balance = '') {
        fetch(`/goods/goods-for-order?page=${currentNewOrdersGoodsPage}&size=${amountNewOrderGoodsPerPage}&name=${name}&categoryId=${categoryId}&price=${price}&balance=${balance}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#newGoodsTable tbody');
                tableBody.innerHTML = '';

                data.content.forEach(good => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${good.name}</td>
                <td>${good.category.name}</td>
                <td>${good.salePrice}</td>
                <td>${good.balance}</td>
                <td>
                    <input type="number" id="quantity_${good.id}" value="1" min="1" max="${good.balance}" style="width: 60px;" />
                </td>
                <td>
                    <button class="add-button" onclick="(() => addGoodToNewOrder(${good.id}))()">Добавить</button>
                </td>
            `;
                    tableBody.appendChild(row);
                });
                document.getElementById('newGoodPageInfo').textContent = `Страница ${data.number + 1} из ${data.totalPages}`;
                currentNewOrdersGoodsPage = data.number;
                totalNewOrderGoodsPages = data.totalPages;

                document.getElementById('newAddGoodFormContainer').style.display = 'block';
            })
            .catch(error => console.error('Ошибка загрузки товаров:', error));
    }

    function prevNewOrderGoodsPage() {
        if (currentNewOrdersGoodsPage > 0) {
            currentNewOrdersGoodsPage--;
            applyNewOrdersGoodsSearch()
        }
    }

    function nextNewOrderGoodsPage() {
        if (currentNewOrdersGoodsPage < totalNewOrderGoodsPages - 1) {
            currentNewOrdersGoodsPage++;
            applyNewOrdersGoodsSearch();
        }
    }

    function setAmountNewOrderGoodsPerPage(size) {
        amountNewOrderGoodsPerPage = size;
        currentNewOrdersGoodsPage = 0;
        applyNewOrdersGoodsSearch();
    }

    function resetInputForNewOrdersGoods(inputId) {
        document.getElementById(inputId).value = '';
        const selectId = inputId.replace('Search', '');
        const selectElement = document.getElementById(selectId);

        if (selectElement) {
            selectElement.selectedIndex = 0;
        }

        applyNewOrdersGoodsSearch();
    }

    let categoriesListForNewOrder = [];

    function toggleNewOrderAddGoodForm() {
        const form = document.getElementById('newAddGoodFormContainer');
        const isFormVisible = form.style.display === 'block';

        if (isFormVisible) {
            form.style.display = 'none';
            return;
        }

        fetch('/categories/list')
            .then(response => response.json())
            .then(categories => {
                console.log(categories);
                categoriesListForNewOrder = categories;
                renderNewOrderCategories(categoriesListForNewOrder);
                loadNewOrderGoodsList();

                form.style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при загрузке категорий:', error);
                alert('Не удалось загрузить категории. Попробуйте позже.');
            });
    }

    function renderNewOrderCategories(categories) {
        const categorySelect = document.getElementById('addCategory');
        categorySelect.innerHTML = '<option value="" disabled selected>Выберите категорию</option>';

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    }

    function filterNewOrderCategories() {
        const searchText = document.getElementById(`addCategorySearch`).value.toLowerCase();
        const filteredCategories = categoriesListForNewOrder.filter(category =>
            category.name.toLowerCase().includes(searchText)
        );
        renderNewOrderCategories(filteredCategories);
    }

    function toggleNewAddGoodFormVisibility() {
        const tableContainer = document.getElementById('newAddGoodFormContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    let goodsToNewOrderAdd = [];

    function addGoodToNewOrder(goodId) {
        const quantityInput = document.getElementById(`quantity_${goodId}`);
        let quantity = parseInt(quantityInput.value, 10);

        if (quantity <= 0) {
            alert('Количество должно быть больше 0');
            return;
        }

        const existingGood = goodsToNewOrderAdd.find(item => item.goodId === goodId);
        if (existingGood) {
            existingGood.quantity += quantity;
        } else {
            goodsToNewOrderAdd.push({goodId, quantity});
        }

        quantityInput.value = 1;
        renderNewAddedGoods();
        updateOrderDetailsWithGoods();
    }

    function renderNewAddedGoods() {
        const tableBody = document.querySelector('#newAddedGoodsTable tbody');
        tableBody.innerHTML = '';

        goodsToNewOrderAdd.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>Товар ${item.goodId}</td>
            <td>
                <input type="number" min="1" value="${item.quantity}" onchange="updateNewGoodQuantity(${index}, this.value)">
            </td>
            <td>
                <button type="button" class="delete-button" onclick="removeNewGood(${index})">Удалить</button>
            </td>
        `;
            tableBody.appendChild(row);
        });

        document.getElementById('newAddedGoodsForm').style.display = goodsToNewOrderAdd.length > 0 ? 'block' : 'none';
    }

    function updateNewGoodQuantity(index, quantity) {
        const updatedQuantity = parseInt(quantity, 10);
        if (updatedQuantity > 0) {
            goodsToNewOrderAdd[index].quantity = updatedQuantity;
        } else {
            alert('Количество должно быть больше 0');
        }
        renderNewAddedGoods();
    }

    function removeNewGood(index) {
        goodsToNewOrderAdd.splice(index, 1);
        renderNewAddedGoods();
    }

    function submitOrder() {
        const companyId = document.getElementById('companySelect').value;
        if (!companyId) {
            alert('Выберите компанию!');
            return;
        }

        if (goodsToNewOrderAdd.length === 0) {
            alert('Добавьте хотя бы один товар.');
            return;
        }

        const createOrderDto = {
            companyId: parseInt(companyId, 10),
            goodOrders: goodsToNewOrderAdd.map(item => ({
                goodId: item.goodId,
                quantity: item.quantity,
            })),
        };

        fetch('/orders/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(createOrderDto),
        })
            .then(response => {
                if (response.status === 201) {
                    alert('Заказ успешно создан!');
                    goodsToNewOrderAdd = [];
                    document.getElementById('newOrderDetailsModal').style.display = 'none';
                    renderNewAddedGoods();
                    updateOrderDetailsWithGoods();
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.message) {
                    alert(`${data.message}`);
                }
            })
            .catch(error => console.error('Ошибка создания заказа:', error));
    }

    function updateOrderDetailsWithGoods() {
        const tableBody = document.querySelector('#newOrderDetailsModal tbody');
        tableBody.innerHTML = '';

        goodsToNewOrderAdd.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>Товар ${item.goodId}</td>
            <td>${item.quantity}</td>
            <td>
                <button type="button" class="delete-button" onclick="removeGoodFromOrder(${index})">Удалить</button>
            </td>
        `;
            tableBody.appendChild(row);
        });
    }

    function confirmNewAddGoods() {
        document.getElementById('newAddedGoodsForm').style.display = 'none';
        updateOrderDetailsWithGoods();
        alert('Изменения подтверждены!');
    }

    function removeGoodFromOrder(index) {
        goodsToNewOrderAdd.splice(index, 1);
        updateOrderDetailsWithGoods();
        renderNewAddedGoods();
    }

    let currentOrdersPage = 0;
    let amountPerPage = 10;
    let totalOrdersPages = 1;

    function applyFilters() {

        const managerSearch = document.getElementById('managerSearch').value;
        const companySearch = document.getElementById('companySearch').value;
        const dateFromSearch = document.getElementById('dateFromSearch').value;
        const dateToSearch = document.getElementById('dateToSearch').value;
        const totalSearch = document.getElementById('totalSearch').value;
        const sortOption = document.getElementById('ordersSort').value;

        loadOrders(managerSearch, companySearch, totalSearch, dateFromSearch, dateToSearch, sortOption);
    }

    function loadOrders(user = '', company = '', totalAmount = '', dateFrom = '', dateTo = '', sort = '') {
        const url = `/orders/page?page=${currentOrdersPage}&size=${amountPerPage}&user=${encodeURIComponent(user)}&company=${encodeURIComponent(company)}&totalAmount=${encodeURIComponent(totalAmount)}&dateFrom=${encodeURIComponent(dateFrom)}&dateTo=${encodeURIComponent(dateTo)}&sort=${encodeURIComponent(sort)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#table tbody');
                tableBody.innerHTML = '';

                data.content.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.user.name + ' ' + order.user.surname}</td>
                        <td>${order.company.name}</td>
                        <td>${order.createdAt}</td>
                        <td>${order.totalAmount}</td>
                        <td>
                            <a href="#" onclick="viewOrderDetails(${order.id})">Детали заказа</a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('ordersPageInfo').textContent = `Страница ${data.number + 1} из ${data.totalPages}`;
                currentOrdersPage = data.number;
                totalOrdersPages = data.totalPages;

                document.getElementById('ordersTableContainer').style.display = 'block';

            })
            .catch(error => {
                console.error('Ошибка при получении заказов:', error);
            });
    }

    function prevOrdersPage() {
        if (currentOrdersPage > 0) {
            currentOrdersPage--;
            loadOrders();
        }
    }

    function nextOrdersPage() {
        if (currentOrdersPage < totalOrdersPages - 1) {
            currentOrdersPage++;
            loadOrders();
        }
    }

    function setAmountOrdersPerPage(amount) {
        amountPerPage = amount;
        loadOrders();
    }

    function resetInput(inputId) {
        document.getElementById(inputId).value = '';
        applyFilters();
    }

    function resetInputForGoods(inputId) {
        document.getElementById(inputId).value = '';
        const selectId = inputId.replace('Search', '');
        const selectElement = document.getElementById(selectId);

        if (selectElement) {
            selectElement.selectedIndex = 0;
        }
        applyGoodsSearch();
    }

    function toggleOrdersTableVisibility() {
        const tableContainer = document.getElementById('ordersTableContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    function toggleAddGoodFormVisibility() {
        const tableContainer = document.getElementById('addGoodFormContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
        viewOrderDetails(currentOrderId)

    }

    let currentOrderId = null;

    function viewOrderDetails(orderId) {
        currentOrderId = orderId;

        fetch(`/orders/goods?orderId=${orderId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при получении данных');
                }
                return response.json();
            })
            .then(orderGoodsList => {
                const tableBody = document.querySelector('#orderGoodsTable tbody');
                tableBody.innerHTML = '';

                orderGoodsList.forEach(orderGoods => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${orderGoods.goodName}</td>
                    <td><input type="number" value="${orderGoods.quantity}" onchange="queueQuantityChange(${orderGoods.id}, this.value)"></td>
                    <td>${orderGoods.sum}</td>
                    <td>
                        <button type="button" class="delete-button" onclick="deleteGoods(${orderGoods.id})">Удалить</button>
                    </td>
                `;
                    tableBody.appendChild(row);
                });

                document.getElementById('orderDetailsModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при получении данных о заказе:', error);
                alert('Не удалось загрузить детали заказа. Пожалуйста, попробуйте позже.');
            });
    }

    function closeOrderDetailsModal() {
        const tableContainer = document.getElementById('orderDetailsModal');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
        applyFilters();
    }

    let changesQueue = [];

    function queueQuantityChange(goodsId, newQuantity) {
        const existingChange = changesQueue.find(change => change.id === goodsId);

        if (existingChange) {
            existingChange.quantity = newQuantity;
        } else {
            changesQueue.push({id: goodsId, quantity: newQuantity});
        }

        console.log('Очередь изменений:', changesQueue);
    }

    function saveAllChanges() {
        if (changesQueue.length === 0) {
            alert('Нет изменений для сохранения.');
            viewOrderDetails(currentOrderId);
        } else {
            fetch('/orders/change', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(changesQueue)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Изменения сохранены');
                        changesQueue = [];
                        viewOrderDetails(currentOrderId);
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.message) {
                        alert(`${data.message}`);
                    }
                })
                .catch(error => console.error('Ошибка при сохранении изменений:', error));
        }
    }

    function deleteGoods(goodsId) {
        fetch(`/orders/delete-good?ordersGoodsId=${goodsId}`, {
            method: 'POST'
        })
            .then(response => {
                if (response.ok) {
                    alert('Товар успешно удалён');
                    viewOrderDetails(currentOrderId);
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.message) {
                    alert(`${data.message}`);
                }
            })
            .catch(error => console.error('Ошибка при удалении товара:', error));
    }


    let categoriesList = [];

    function toggleAddGoodForm() {
        const form = document.getElementById('addGoodFormContainer');
        const isFormVisible = form.style.display === 'block';

        if (isFormVisible) {
            form.style.display = 'none';
            return;
        }
        fetch('/categories/list')
            .then(response => response.json())
            .then(categories => {
                categoriesList = categories;
                renderCategories(categoriesList);
                loadGoodsList(currentOrderId);

                form.style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при загрузке категорий:', error);
                alert('Не удалось загрузить категории. Попробуйте позже.');
            });
    }

    function closeAddGoodForm() {
        const form = document.getElementById('addedGoodsForm');
        form.style.display = 'none';  // Закрываем форму
    }

    function renderCategories(categories) {
        const categorySelect = document.getElementById('editCategory');
        categorySelect.innerHTML = '<option value="" disabled selected>Выберите категорию</option>';

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    }

    function filterCategories() {
        const searchText = document.getElementById(`editCategorySearch`).value.toLowerCase();
        const filteredCategories = categoriesList.filter(category =>
            category.name.toLowerCase().includes(searchText)
        );
        renderCategories(filteredCategories);
    }

    function applyGoodsSearch() {
        const goodNameSearch = document.getElementById('searchGood').value;
        const selectedCategory = document.getElementById('editCategory').value;
        const salePriceSearch = document.getElementById('salePriceSearch').value;
        const balanceSearch = document.getElementById('balanceSearch').value;
        loadGoodsList(currentOrderId, goodNameSearch, selectedCategory, salePriceSearch, balanceSearch);
    }


    let currentGoodsPage = 0;
    let amountGoodsPerPage = 5;
    let totalGoodsPages = 1;

    function loadGoodsList(orderId, name = '', categoryId = '', price = '', balance = '') {
        fetch(`/goods/goods-for-order?page=${currentGoodsPage}&size=${amountGoodsPerPage}&name=${name}&categoryId=${categoryId}&price=${price}&balance=${balance}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#goodsTable tbody');
                tableBody.innerHTML = '';

                data.content.forEach(good => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${good.name}</td>
                <td>${good.category.name}</td>
                <td>${good.salePrice}</td>
                <td>${good.balance}</td>
                <td>
                    <input type="number" id="quantity_${good.id}" value="1" min="1" max="${good.balance}" style="width: 60px;" />
                </td>
                <td>
                    <button class="add-button" onclick="(() => addGoodToOrder(${good.id}, ${orderId}))()">Добавить</button>
                </td>
            `;
                    tableBody.appendChild(row);
                });
                document.getElementById('goodPageInfo').textContent = `Страница ${data.number + 1} из ${data.totalPages}`;
                currentGoodsPage = data.number;
                totalGoodsPages = data.totalPages;

                document.getElementById('ordersTableContainer').style.display = 'block';
            })
            .catch(error => console.error('Ошибка загрузки товаров:', error));
    }


    function prevGoodsPage() {
        if (currentGoodsPage > 0) {
            currentGoodsPage--;
            applyGoodsSearch()
        }
    }

    function nextGoodsPage() {
        if (currentGoodsPage < totalGoodsPages - 1) {
            currentGoodsPage++;
            applyGoodsSearch();
        }
    }

    function setAmountGoodsPerPage(size) {
        amountGoodsPerPage = size;
        currentGoodsPage = 0;
        applyGoodsSearch();
    }


    let goodsToAdd = [];

    function addGoodToOrder(goodId, orderId) {
        const quantityInput = document.getElementById(`quantity_${goodId}`);
        let quantity = parseInt(quantityInput.value, 10);

        if (quantity <= 0) {
            alert('Количество должно быть больше 0');
            return;
        }

        goodsToAdd.push({orderId, goodId, quantity, name: `Товар ${goodId}`}); // Добавляем имя товара

        quantityInput.value = 1;
        renderAddedProducts();
    }

    function confirmAddGoods() {
        if (goodsToAdd.length === 0) {
            alert('Нет изменений для сохранения.');
            viewOrderDetails(currentOrderId);
        }

        fetch('/orders/add-goods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(goodsToAdd),
        })
            .then(response => {
                if (response.status === 201) {
                    alert('Изменения успешно сохранены!');
                    goodsToAdd = [];
                    renderAddedProducts();
                    closeAddGoodForm();
                    toggleAddGoodFormVisibility();
                    viewOrderDetails(currentOrderId);
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.message) {
                    alert(`${data.message}`);
                }
            })
            .catch(error => {
                console.error('Произошла ошибка:', error);
                alert('Произошла ошибка при обработке запроса. Попробуйте снова.');
            });
    }

    function renderAddedProducts() {
        const tableBody = document.querySelector('#addedGoodsTable tbody');
        tableBody.innerHTML = '';

        goodsToAdd.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${item.name || 'Товар ' + item.goodId}</td>
        <td>
            <input type="number" min="1" value="${item.quantity}" onchange="updateAddedQuantity(${index}, this.value)">
        </td>
        <td>
            <button type="button" class="delete-button" onclick="removeAddedProduct(${index})">Удалить</button>
        </td>
    `;
            tableBody.appendChild(row);
        });

        document.getElementById('addedGoodsForm').style.display = goodsToAdd.length > 0 ? 'block' : 'none';
    }

    function updateAddedQuantity(index, quantity) {
        goodsToAdd[index].quantity = parseInt(quantity, 10);
        if (goodsToAdd[index].quantity <= 0) {
            goodsToAdd[index].quantity = 1;
        }
        renderAddedProducts();
    }

    function removeAddedProduct(index) {
        goodsToAdd.splice(index, 1);
        renderAddedProducts();
    }

    flatpickr("#dateFromSearch, #dateToSearch", {
        locale: "ru",
        dateFormat: "Y-m-d",
        allowInput: true,
        onChange: function () {
            applyFilters();
        }
    });

</script>