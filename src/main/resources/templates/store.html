<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление поставками</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

</head>
<body>

<header>
    <div class="container">
        <h1 class="logo">
            <i class="fas fa-truck"></i> Управление поставками
        </h1>
        <nav class="navbar">
            <a href="/" class="active"><i class="fas fa-home"></i> Главная</a>
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> Выйти</a>
        </nav>
    </div>
</header>

<main>
    <div class="management">
        <div class="management-title">
            <h2>Управление поставками</h2>
            <p>Здесь вы можете управлять товарами и категориями системы.</p>
        </div>

        <div class="management-actions">

            <div class="button-container">
                <button class="management-item" onclick="viewWriteOfArrivalFrom()">
                    <i class="fas fa-minus-circle"></i> Списать товары
                    <span class="management-tooltip">Списать товары со склада</span>
                </button>
            </div>

            <div class="button-container">
                <button class="management-item" onclick="viewWriteOfArrivalFrom()">
                    <i class="fas fa-plus-circle"></i> Зачислить товары
                    <span class="management-tooltip">Зачислить товары на склад</span>
                </button>
            </div>

            <div class="button-container">
                <button class="management-item" onclick="loadHistory()">
                    <i class="fas fa-history"></i> Получить историю
                    <span class="management-tooltip">Посмотреть историю операций с товарами</span>
                </button>
            </div>

        </div>
    </div>

    <div class="table-container" id="operationHistoryTableContainer" style="display: none; margin-top: 20px;">
        <h3>История списаний и зачислений</h3>
        <table id="operationHistoryTable">
            <thead>
            <tr>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="goodNameSearch" placeholder="Поиск по товару"
                               oninput="applyHistoryFilters()">
                        <button type="button" onclick="resetInput('goodNameSearch')" class="reset-button">&#10006;
                        </button>
                    </div>
                </th>

                <th>
                    <div class="input-with-reset search-item" style="min-width: 30px; width: 200px;">
                        <input type="text" id="purchasePriceSearch" placeholder="Поиск по цене закупки"
                               oninput="applyHistoryFilters()">
                        <button type="button" onclick="resetInput('purchasePriceSearch')" class="reset-button">
                            &#10006;
                        </button>
                    </div>
                </th>

                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="arrivedTotalSearch" placeholder="Поиск по поступлению"
                               oninput="applyHistoryFilters()">
                        <button type="button" onclick="resetInput('arrivedTotalSearch')" class="reset-button">&#10006;
                        </button>
                    </div>
                </th>

                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="consumptionTotalSearch" placeholder="Поиск по списанию"
                               oninput="applyHistoryFilters()">
                        <button type="button" onclick="resetInput('consumptionTotalSearch')" class="reset-button">
                            &#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="reasonSearch" placeholder="Поиск по причине"
                               oninput="applyHistoryFilters()">
                        <button type="button" onclick="resetInput('reasonSearch')" class="reset-button">&#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="dateFromSearch" placeholder="Дата от" class="date-input">
                        <button type="button" onclick="resetInput('dateFromSearch'); resetInput('dateToSearch')"
                                class="reset-button">&#10006;
                        </button>
                        <input type="text" id="dateToSearch" placeholder="Дата до" class="date-input">
                        <button type="button" onclick="resetInput('dateFromSearch'); resetInput('dateToSearch')"
                                class="reset-button">&#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="sort-container">
                        <label for="historySort">Сортировать по:</label>
                        <select id="historySort" onchange="applyHistoryFilters()">
                            <option value="">Выберите</option>
                            <option value="good_name_asc">Товар (А-Я)</option>
                            <option value="good_name_desc">Товар (Я-А)</option>
                            <option value="purchase_price_asc">Цена закупки (по возрастанию)</option>
                            <option value="purchase_price_desc">Цена закупки (по убыванию)</option>
                            <option value="arrived_total_asc">Поступление (по возрастанию)</option>
                            <option value="arrived_total_desc">Поступление (по убыванию)</option>
                            <option value="consumption_total_asc">Списание (по возрастанию)</option>
                            <option value="consumption_total_desc">Списание (по убыванию)</option>
                            <option value="reason_asc"> Причина (А-Я)</option>
                            <option value="reason_desc">Причина (Я-А)</option>
                            <option value="date_asc">Дата (по возрастанию)</option>
                            <option value="date_desc">Дата (по убыванию)</option>

                        </select>
                    </div>
                </th>
            </tr>
            <tr>
                <th>Название товара</th>
                <th>Цена закупки</th>
                <th>Количество поступлений</th>
                <th>Количество списаний</th>
                <th>Причина списания</th>
                <th>Дата операции</th>
                <th></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="historyPagination">
            <button onclick="goToNextHistoryPage()">Назад</button>
            <span id="historyPageInfo">Страница 1</span>
            <button onclick="goToPreviousHistoryPage()">Вперед</button>
        </div>

        <div class="page-size-selector">
            <button onclick="setAmountHistoryPerPage(10)">10</button>
            <button onclick="setAmountHistoryPerPage(30)">30</button>
            <button onclick="setAmountHistoryPerPage(90)">90</button>
        </div>

        <div class="hide-table-btn-container">
            <button class="hide-table-btn" onclick="toggleHistoryTableVisibility()">Скрыть таблицу</button>
        </div>
    </div>

    <div class="table-container" id="goodsTableContainer" style="display: none; margin-top: 20px;">
        <h3>Списание и зачисление товаров</h3>
        <table id="goodsTable">
            <thead>
            <tr>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="nameSearch" placeholder="Поиск по названию"
                               oninput="applyGoodsFilters()">
                        <button type="button" onclick="resetInputForGoods('nameSearch')" class="reset-button">&#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="addCategorySearch" placeholder="Поиск по категории"
                               oninput="filterNewOrderCategories()">
                        <button type="button" onclick="resetInputForGoods('addCategorySearch')" class="reset-button">
                            &#10006;
                        </button>
                        <select id="addCategory" class="category-select" onchange="applyGoodsFilters()" required
                                size="3">
                            <option value="" disabled selected>Выберите категорию</option>
                        </select>
                    </div>
                </th>

                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="purchaseGoodPriceSearch" placeholder="Поиск по цене закупки"
                               oninput="applyGoodsFilters()">
                        <button type="button" onclick="resetInputForGoods('purchaseGoodPriceSearch')" class="reset-button">
                            &#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="salePriceSearch" placeholder="Поиск по цене продажи"
                               oninput="applyGoodsFilters()">
                        <button type="button" onclick="resetInputForGoods('salePriceSearch')" class="reset-button">
                            &#10006;
                        </button>

                    </div>
                </th>
                <th>
                    <div class="input-with-reset search-item">
                        <input type="text" id="balanceSearch" placeholder="Поиск по остатку"
                               oninput="applyGoodsFilters()">
                        <button type="button" onclick="resetInputForGoods('balanceSearch')" class="reset-button">
                            &#10006;
                        </button>
                    </div>
                </th>
                <th>
                    <div class="sort-container">
                        <label for="goodsSort">Сортировать по:</label>
                        <select id="goodsSort" onchange="applyGoodsFilters()">
                            <option value="">Выберите</option>
                            <option value="name_asc">Название (А-Я)</option>
                            <option value="name_desc">Название (Я-А)</option>
                            <option value="category_asc"> Категория (А-Я)</option>
                            <option value="category_desc">Категория (Я-А)</option>
                            <option value="purchase_price_asc">Цена закупки (А-Я)</option>
                            <option value="purchase_price_desc">Цена закупки (Я-А)</option>
                            <option value="sale_price_asc"> Цена продажи (по возрастанию)</option>
                            <option value="sale_price_desc">Цена продажи (по убыванию)</option>
                            <option value="balance_asc"> Остаток (по возрастанию)</option>
                            <option value="balance_desc">Остаток (по убыванию)</option>
                        </select>
                    </div>
                </th>
            </tr>
            <tr>
                <th>Название товара</th>
                <th>Категория</th>
                <th>Цена закупки</th>
                <th>Цена продажи</th>
                <th>Количество</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="goodsPagination">
            <button onclick="prevGoodsPage()">Назад</button>
            <span id="goodsPageInfo">Страница 1</span>
            <button onclick="nextGoodsPage()">Вперед</button>
        </div>

        <div class="page-size-selector">
            <button onclick="setAmountGoodsPerPage(10)">10</button>
            <button onclick="setAmountGoodsPerPage(30)">30</button>
            <button onclick="setAmountGoodsPerPage(90)">90</button>
        </div>
        <div class="hide-table-btn-container">
            <button class="hide-table-btn" onclick="toggleGoodsTableVisibility()">Скрыть таблицу</button>
        </div>
    </div>

    <div class = "add-form" id="writeOffForm" style="display: none;">
        <h3>Списание товара</h3>
        <form onsubmit="submitWriteOffForm(event)">
            <label>Название товара:</label>
            <input type="text" id="writeOffName" readonly>
            <label>Цена закупки:</label>
            <input type="number" id="writeOffPrice">
            <label>Количество списания:</label>
            <input type="number" id="writeOffAmount" required>
            <label>Причина:</label>
            <input type="text" id="writeOffReason" required>
            <button class="btn-success" type="submit">Списать</button>
            <button class="btn-danger" type="button" onclick="closeForm('writeOffForm')">Отмена</button>
        </form>
    </div>

    <div class = "add-form" id="arrivalForm" style="display: none;">
        <h3>Зачисление товара</h3>
        <form onsubmit="submitArrivalForm(event)">
            <label>Название товара:</label>
            <input type="text" id="arrivalName" readonly>
            <label>Цена закупки:</label>
            <input type="number" id="arrivalPrice">
            <label>Количество зачисления:</label>
            <input type="number" id="arrivalAmount" required>
            <label>Причина:</label>
            <input type="text" id="arrivalReason" required>
            <button class="btn-success" type="submit">Зачислить</button>
            <button class="btn-danger" type="button" onclick="closeForm('arrivalForm')">Отмена</button>
        </form>
    </div>


    <button onclick="window.location.href='/'" class="back-to-main-btn">Вернуться на главную</button>
</main>

<footer>
    <p>&copy; 2024 Система управления товарами и категориями</p>
</footer>

<script>

    function resetInputForGoods(inputId) {
        document.getElementById(inputId).value = '';
        const selectId = inputId.replace('Search', '');
        const selectElement = document.getElementById(selectId);

        if (selectElement) {
            selectElement.selectedIndex = 0;
        }
        applyGoodsFilters();
    }

    function openWriteOffForm(name, price) {
        document.getElementById('writeOffName').value = name;
        document.getElementById('writeOffPrice').value = price;
        document.getElementById('writeOffForm').style.display = 'block';
    }

    function openArrivalForm(name, price) {
        document.getElementById('arrivalName').value = name;
        document.getElementById('arrivalPrice').value = price;
        document.getElementById('arrivalForm').style.display = 'block';
    }

    function closeForm(formId) {
        document.getElementById(formId).style.display = 'none';
    }

    function submitWriteOffForm(event) {
        event.preventDefault();
        const data = {
            goodName: document.getElementById('writeOffName').value,
            purchasePrice: parseFloat(document.getElementById('writeOffPrice').value),
            consumptionTotal: parseInt(document.getElementById('writeOffAmount').value, 10),
            reason: document.getElementById('writeOffReason').value
        };

        fetch('/store/consumption', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert('Товар успешно списан.');
                    closeForm('writeOffForm');
                    loadGoods();
                } else {
                    alert('Ошибка при списании товара.');
                }
            })
            .catch(error => console.error('Ошибка:', error));
    }

    function submitArrivalForm(event) {
        event.preventDefault();
        const data = {
            goodName: document.getElementById('arrivalName').value,
            purchasePrice: parseFloat(document.getElementById('arrivalPrice').value),
            arrivedTotal: parseInt(document.getElementById('arrivalAmount').value, 10),
            reason: document.getElementById('arrivalReason').value
        };

        fetch('/store/arrival', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert('Товар успешно зачислен.');
                    closeForm('arrivalForm');
                    loadGoods();
                } else {
                    alert('Ошибка при зачислении товара.');
                }
            })
            .catch(error => console.error('Ошибка:', error));
    }


    let categoriesListForNewOrder = [];

    function viewWriteOfArrivalFrom() {
        const form = document.getElementById('goodsTableContainer');
        const isFormVisible = form.style.display === 'block';

        if (isFormVisible) {
            form.style.display = 'none';
            return;
        }

        fetch('/categories/list')
            .then(response => response.json())
            .then(categories => {
                categoriesListForNewOrder = categories;
                renderNewOrderCategories(categoriesListForNewOrder);
                applyGoodsFilters();

                form.style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при загрузке категорий:', error);
                alert('Не удалось загрузить категории. Попробуйте позже.');
            });
    }

    function renderNewOrderCategories(categories) {
        const categorySelect = document.getElementById('addCategory');
        categorySelect.innerHTML = '<option value="" disabled selected>Выберите категорию</option>';

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    }

    function filterNewOrderCategories() {
        const searchText = document.getElementById(`addCategorySearch`).value.toLowerCase();
        const filteredCategories = categoriesListForNewOrder.filter(category =>
            category.name.toLowerCase().includes(searchText)
        );
        renderNewOrderCategories(filteredCategories);
    }

    let currentGoodsPage = 0;
    let amountPerPage = 10;
    let totalGoodsPages = 1;


    function applyGoodsFilters() {
        const nameSearch = document.getElementById('nameSearch').value;
        const categorySearch = document.getElementById('addCategory').value;
        const purchasePriceSearch = document.getElementById('purchaseGoodPriceSearch').value;
        const salePriceSearch = document.getElementById('salePriceSearch').value;
        const balanceSearch = document.getElementById('balanceSearch').value;
        const sortOption = document.getElementById('goodsSort').value;

        loadGoods(nameSearch, categorySearch, purchasePriceSearch, salePriceSearch, balanceSearch, sortOption);
    }

    function loadGoods(name = '', categorySearch = '', purchasePriceSearch = '', salePriceSearch = '', balanceSearch = '', sort = '') {
        const url = `/goods/page?page=${currentGoodsPage}&size=${amountPerPage}&name=${encodeURIComponent(name)}&category=${encodeURIComponent(categorySearch)}&purchasePrice=${encodeURIComponent(purchasePriceSearch)}&salePrice=${encodeURIComponent(salePriceSearch)}&balance=${encodeURIComponent(balanceSearch)}&sort=${encodeURIComponent(sort)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#goodsTable tbody');
                tableBody.innerHTML = '';

                data.content.forEach(good => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${good.name}</td>
                    <td>${good.category.name}</td>
                    <td>${good.purchasePrice}</td>
                    <td>${good.salePrice}</td>
                    <td>${good.balance}</td>
                  <td>
                       <button class="btn-success" onclick="openArrivalForm('${good.name}', ${good.purchasePrice})">Зачислить</button>
                        <button class="btn-danger" onclick="openWriteOffForm('${good.name}', ${good.purchasePrice})">Списать</button>
                  </td>
                `;
                    tableBody.appendChild(row);
                });

                document.getElementById('goodsPageInfo').textContent = `Страница ${data.number + 1} из ${data.totalPages}`;
                currentGoodsPage = data.number;
                totalGoodsPages = data.totalPages;

                document.getElementById('goodsTableContainer').style.display = 'block';
            })
            .catch(error => console.error('Ошибка при получении товаров:', error));
    }

    function prevGoodsPage() {
        if (currentGoodsPage > 0) {
            currentGoodsPage--;
            loadGoods();
        }
    }

    function nextGoodsPage() {
        if (currentGoodsPage < totalGoodsPages - 1) {
            currentGoodsPage++;
            loadGoods();
        }
    }

    function setAmountGoodsPerPage(size) {
        amountPerPage = size;
        currentGoodsPage = 0;
        loadGoods();
    }

    function toggleGoodsTableVisibility() {
        const tableContainer = document.getElementById('goodsTableContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }


    let currentHistoryPage = 0;
    let amountHistoryPerPage = 10;
    let totalHistoryPages = 1;

    function applyHistoryFilters() {
        const goodNameSearch = document.getElementById('goodNameSearch').value;
        const purchasePrice = document.getElementById('purchasePriceSearch').value;
        const arrivedTotal = document.getElementById('arrivedTotalSearch').value;
        const consumptionTotal = document.getElementById('consumptionTotalSearch').value;
        const reason = document.getElementById('reasonSearch').value;
        const dateFrom = document.getElementById('dateFromSearch').value;
        const dateTo = document.getElementById('dateToSearch').value;
        const sortOption = document.getElementById('historySort').value;

        loadHistory(goodNameSearch, purchasePrice, arrivedTotal, consumptionTotal, reason, dateFrom, dateTo, sortOption);
    }

    function loadHistory(
        goodName = '',
        purchasePrice = '',
        arrivedTotal = '',
        consumptionTotal = '',
        reason = '',
        dateFrom = '',
        dateTo = '',
        sort = ''
    ) {
        const url = `/store/page?page=${currentHistoryPage}&size=${amountHistoryPerPage}&goodName=${encodeURIComponent(goodName)}&purchasePrice=${encodeURIComponent(purchasePrice)}&arrivedTotal=${encodeURIComponent(arrivedTotal)}&consumptionTotal=${encodeURIComponent(consumptionTotal)}&reason=${encodeURIComponent(reason)}&dateFrom=${encodeURIComponent(dateFrom)}&dateTo=${encodeURIComponent(dateTo)}&sort=${encodeURIComponent(sort)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#operationHistoryTable tbody');
                tableBody.innerHTML = '';

                data.content.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${record.goodName}</td>
                    <td>${record.purchasePrice}</td>
                    <td>${record.arrivedTotal}</td>
                    <td>${record.consumptionTotal}</td>
                    <td>${record.reason}</td>
                    <td>${record.createdAt}</td>
                    <td></td>
                `;
                    tableBody.appendChild(row);
                });

                document.getElementById('historyPageInfo').textContent = `Страница ${data.number + 1} из ${data.totalPages}`;
                currentHistoryPage = data.number;
                totalHistoryPages = data.totalPages;

                document.getElementById('operationHistoryTableContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при получении истории:', error);
            });
    }

    function goToNextHistoryPage() {
        if (currentHistoryPage < totalHistoryPages - 1) {
            currentHistoryPage++;
            applyHistoryFilters();
        }
    }

    function goToPreviousHistoryPage() {
        if (currentHistoryPage > 0) {
            currentHistoryPage--;
            applyHistoryFilters();
        }
    }

    function setAmountHistoryPerPage(amount) {
        amountHistoryPerPage = amount;
        applyHistoryFilters();
    }

    function toggleHistoryTableVisibility() {
        const tableContainer = document.getElementById('operationHistoryTableContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    function resetInput(inputId) {
        document.getElementById(inputId).value = '';
        applyHistoryFilters();
    }

    flatpickr("#dateFromSearch, #dateToSearch", {
        locale: "ru",
        dateFormat: "Y-m-d\\\\TH:i:S",
        allowInput: true,
        onChange: function () {
            applyHistoryFilters();
        }
    });

</script>