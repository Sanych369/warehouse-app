<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление товарами и категориями</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<header>
    <div class="container">
        <h1 class="logo">Панель администратора</h1>
        <nav class="navbar">
            <a href="/admin">Главная</a>
            <a href="/admin/users">Пользователи</a>
            <a href="/admin/goods">Товары</a>
            <a href="/logout">Выйти</a>
        </nav>
    </div>
</header>

<main>
    <div class="management">
        <div class="management-title">
            <h2>Управление товарами и категориями</h2>
            <p>Здесь вы можете управлять товарами и категориями системы.</p>
        </div>

        <div class="management-actions">
            <div class="button-container">
                <button class="dashboard-item" onclick="loadGoods()">Получить список товаров</button>
            </div>
            <div class="button-container">
                <button class="dashboard-item" onclick="showAddGoodForm()">Добавить товар</button>
            </div>
            <div class="button-container">
                <button class="dashboard-item" onclick="loadCategories()">Получить список категорий</button>
            </div>
            <div class="button-container">
                <button class="dashboard-item" onclick="showAddCategoryForm()">Добавить категорию</button>
            </div>
        </div>

        <div class="goods-table-container" id="goodsTableContainer" style="display:none; margin-top: 20px;">
            <table id="goodsTable">
                <thead>
                <tr>
                    <th>Название товара</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Количество</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button class="hide-table-btn" onclick="toggleGoodsTableVisibility()">Скрыть таблицу</button>
        </div>

        <div class="categories-table-container" id="categoriesTableContainer" style="display:none; margin-top: 20px;">
            <table id="table">
                <thead>
                <tr>
                    <th>Название категории</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button class="hide-table-btn" onclick="toggleCategoriesTableVisibility()">Скрыть таблицу</button>
        </div>
    </div>

    <!-- Форма для добавления товаров -->
    <div class="add-good-form" id="addGoodForm" style="display:none;">
        <h3>Добавить товар</h3>
        <form id="addGoodFormElement">
            <label for="addGoodName">Название товара:</label>
            <input type="text" id="addGoodName" required>

            <label for="addCategory">Категория:</label>
            <select id="addCategory" required>
                <option value="" disabled selected>Выберите категорию</option>
            </select>

            <label for="addPrice">Цена:</label>
            <input type="number" id="addPrice" required>

            <label for="addBalance">Количество:</label>
            <input type="number" id="addBalance" required>

            <button type="button" onclick="addGood()">Добавить товар</button>
            <button type="button" onclick="cancelAddGood()">Отмена</button>
        </form>
    </div>

    <!-- Форма для добавления категорий -->
    <div class="add-category-form" id="addCategoryForm" style="display:none;">
        <h3>Добавить категорию</h3>
        <form id="addCategoryFormElement">
            <label for="addCategoryName">Название категории:</label>
            <input type="text" id="addCategoryName" required>

            <button type="button" onclick="addCategory()">Добавить категорию</button>
            <button type="button" onclick="cancelAddCategory()">Отмена</button>
        </form>
    </div>
</main>

<footer>
    <p>&copy; 2024 Система управления товарами и категориями</p>
</footer>

<script>
    function loadGoods() {
        fetch('/goods/list')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#goodsTable tbody');
                tableBody.innerHTML = '';

                data.forEach(good => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${good.name}</td>
                    <td>${good.category}</td>
                    <td>${good.price}</td>
                    <td>${good.balance}</td>
                    <td>
                        <a href="#" onclick="editGood(${good.id})">Редактировать</a> |
                        <a href="#" onclick="deleteGood(${good.id})">Удалить</a>
                    </td>
                `;
                    tableBody.appendChild(row);
                });

                document.getElementById('goodsTableContainer').style.display = 'block';
            })
            .catch(error => console.error('Ошибка при получении списка товаров:', error));
    }


    function toggleGoodsTableVisibility() {
        const tableContainer = document.getElementById('goodsTableContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    function loadCategories() {
        fetch('/ca/list')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#table tbody');
                tableBody.innerHTML = '';

                data.forEach(category => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                    <td>${category.name}</td>
                    <td>
                        <a href="#" onclick="deleteCategoryById('${category.id}')">Удалить</a>
                    </td>
                `;

                    tableBody.appendChild(row);
                });

                document.getElementById('categoriesTableContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при получении категорий:', error);
            });
    }

    function toggleCategoriesTableVisibility() {
        const tableContainer = document.getElementById('categoriesTableContainer');
        tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
    }

    function showAddGoodForm() {
        fetch('/category/list')
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('addCategory');
                categorySelect.innerHTML = '<option value="" disabled selected>Выберите категорию</option>'; // Сброс списка

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });

                document.getElementById('addGoodForm').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при загрузке категорий:', error);
                alert('Не удалось загрузить категории. Попробуйте позже.');
            });
    }

    function cancelAddGood() {
        document.getElementById('addGoodForm').style.display = 'none';
    }

    function addGood() {
        const newGood = {
            name: document.getElementById('addGoodName').value,
            category: document.getElementById('addCategory').value,
            price: document.getElementById('addPrice').value,
            balance: document.getElementById('addBalance').value
        };

        fetch('/goods/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newGood)
        })
            .then(response => {
                if (response.ok) {
                    alert('Товар успешно добавлен.');
                    loadGoods();
                    cancelAddGood();
                } else {
                    alert('Ошибка при добавлении товара.');
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении товара:', error);
            });
    }

    function editGoodById(id) {
        fetch(`/goods/getById?id=${encodeURIComponent(id)}`)
            .then(response => response.json())
            .then(good => {
                document.getElementById('editGoodName').value = good.name;
                document.getElementById('editCategory').value = good.category;
                document.getElementById('editPrice').value = good.price;
                document.getElementById('editQuantity').value = good.quantity;

                document.getElementById('editGoodForm').style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных товара:', error);
            });
    }

    function deleteGoodById(id) {
        fetch(`/goods/delete?id=${encodeURIComponent(id)}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    alert('Товар успешно удален.');
                    loadGoods();
                } else {
                    alert('Ошибка при удалении товара.');
                }
            })
            .catch(error => {
                console.error('Ошибка при удалении товара:', error);
            });
    }

    function showAddCategoryForm() {
        document.getElementById('addCategoryForm').style.display = 'block';
    }

    function cancelAddCategory() {
        document.getElementById('addCategoryForm').style.display = 'none';
    }

    function addCategory() {
        const newCategory = {
            name: document.getElementById('addCategoryName').value
        };

        fetch('/categories/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newCategory)
        })
            .then(response => {
                if (response.ok) {
                    alert('Категория успешно добавлена.');
                    loadCategories();
                    cancelAddCategory();
                } else {
                    alert('Ошибка при добавлении категории.');
                }
            })
            .catch(error => {
                console.error('Ошибка при добавлении категории:', error);
            });
    }
</script>